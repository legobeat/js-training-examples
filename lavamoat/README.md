# Sample app demonstrating usage of LavaMoat

- `./app` - the app fitted with LavaMoat
- `./app_before` - the original app you can start with to reproduce the process

## How to explore this example

0. `cd app`
1. `npm ci`
2. take a look at package.json and index.js to understand the app a bit
3. `npm test` - runs the server without lavamoat protections
4. go to `http://127.0.0.1:3000/poem` and `http://127.0.0.1:3000/admin`
5. look at `lavamoat/node/policy.json` file briefly
6. check out what the evil_sample package does in `not-npm/evil_sample.js`
7. update evil_sample to 1.0.1
8. run `npm test` and go to `http://127.0.0.1:3000/poem` - it silently sends the request
9. run `npm start` and go to `http://127.0.0.1:3000/poem` - it errors out because lavamoat prevents access to https
10. update evil_sample to 1.0.2 
11. run `npm test` and go to `http://127.0.0.1:3000/admin` - it says you're allowed in
12. run `npm start` - the server won't start because of an uncaught error frm the attempt to poison prototype

Note `lavamoat/node/policy-override.json` is used to preserve your changes to the policy when policy.json is being regenerated.
In this example it's used to demonstrate how certain autogenerated permissions can be stripped


## How we got here AKA the setup process

```
npm i -D @lavamoat/allow-scripts
npx allow-scripts setup # creates the .npmrc entry and adds the postinstall fallback package
npx allow-scripts auto  # detects scripts and populates the allowlist
npm i -D lavamoat patch-package
npx lavamoat --autopolicy index.js  # generates policy.json
npx lavamoat index.js               # runs the server with lavamoat for the first time
# error :(
# fix `main` field in package.json of tiny-lru
npx patch-package tiny-lru
# nothing happened
npx patch-package tiny-lru --exclude 'nothing'
# now the patch includes package.json changes
npx lavamoat --autopolicy index.js
npx lavamoat index.js  
# works
```

But I don't want to endorse using npx all the time, so the useful commands are listed as scripts in package.json.